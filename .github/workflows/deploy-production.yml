name: Deploy to Production

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '*.md'
      - '.github/workflows/ci-coverage.yml'
  workflow_dispatch:

env:
  DEPLOYMENT_ENV: production
  DJANGO_SETTINGS_MODULE: leumasp.settings

jobs:
  pre-deployment-checks:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run Django system checks
      run: python manage.py check --deploy

    - name: Run test suite
      run: python manage.py test leumas --verbosity=2

    - name: Check database migrations
      run: python manage.py migrate --plan

  build-docker-image:
    needs: pre-deployment-checks
    runs-on: ubuntu-latest
    if: success()
    permissions:
      contents: read
      packages: write
    steps:
    - uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v2
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:latest
          ghcr.io/${{ github.repository }}:${{ github.sha }}
        cache-from: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache
        cache-to: type=registry,ref=ghcr.io/${{ github.repository }}:buildcache,mode=max

  deploy-pythonanywhere:
    needs: build-docker-image
    runs-on: ubuntu-latest
    if: success()
    steps:
    - uses: actions/checkout@v3

    - name: Deploy to PythonAnywhere
      env:
        PYTHONANYWHERE_API_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        PA_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
      run: |
        pip install pythonanywhere
        # Reload the app on PythonAnywhere
        curl -u "$PA_USERNAME:$PYTHONANYWHERE_API_TOKEN" https://www.pythonanywhere.com/api/v0/user/$PA_USERNAME/webapps/${PA_USERNAME}.pythonanywhere.com/reload/

    - name: Verify deployment
      run: |
        sleep 30
        curl -f https://${{ secrets.PYTHONANYWHERE_USERNAME }}.pythonanywhere.com/api/health/ || exit 1

  health-check:
    needs: deploy-pythonanywhere
    runs-on: ubuntu-latest
    if: success()
    steps:
    - name: Check application health
      run: |
        for i in {1..10}; do
          if curl -f https://${{ secrets.PYTHONANYWHERE_USERNAME }}.pythonanywhere.com/api/health/ 2>/dev/null; then
            echo "‚úì Application is healthy"
            exit 0
          fi
          echo "Attempt $i/10 - Waiting for app to be ready..."
          sleep 10
        done
        echo "‚úó Application failed to respond"
        exit 1

  smoke-tests:
    needs: health-check
    runs-on: ubuntu-latest
    if: success()
    steps:
    - name: Run smoke tests
      env:
        APP_URL: https://${{ secrets.PYTHONANYWHERE_USERNAME }}.pythonanywhere.com
      run: |
        echo "Testing homepage..."
        curl -f "$APP_URL/" > /dev/null
        
        echo "Testing API endpoints..."
        curl -f "$APP_URL/api/skills/" > /dev/null
        curl -f "$APP_URL/api/portfolios/" > /dev/null
        curl -f "$APP_URL/api/services/" > /dev/null
        curl -f "$APP_URL/api/blogs/" > /dev/null
        
        echo "Testing form submission..."
        curl -f -X POST "$APP_URL/api/newsletter/" \
          -H "Content-Type: application/json" \
          -d '{"email":"test@example.com"}' || true
        
        echo "‚úì All smoke tests passed"

  notify-deployment:
    needs: [smoke-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Determine deployment status
      id: status
      run: |
        if [ "${{ needs.smoke-tests.result }}" == "success" ]; then
          echo "status=‚úÖ DEPLOYMENT SUCCESSFUL" >> $GITHUB_OUTPUT
          echo "color=0x28a745" >> $GITHUB_OUTPUT
        else
          echo "status=‚ùå DEPLOYMENT FAILED" >> $GITHUB_OUTPUT
          echo "color=0xdc3545" >> $GITHUB_OUTPUT
        fi

    - name: Send GitHub notification
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.repos.createDeploymentStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            deployment_id: context.payload.deployment?.id,
            state: '${{ needs.smoke-tests.result }}',
            environment_url: 'https://${{ secrets.PYTHONANYWHERE_USERNAME }}.pythonanywhere.com',
            description: 'Deployed to production'
          })

    - name: Create deployment annotation
      run: |
        echo "## ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Deployment Details:**" >> $GITHUB_STEP_SUMMARY
        echo "- Git SHA: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Environment: Production" >> $GITHUB_STEP_SUMMARY
        echo "- Deployed by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_STEP_SUMMARY

  rollback-on-failure:
    needs: [smoke-tests]
    runs-on: ubuntu-latest
    if: failure()
    steps:
    - name: Trigger rollback
      env:
        PYTHONANYWHERE_API_TOKEN: ${{ secrets.PYTHONANYWHERE_API_TOKEN }}
        PA_USERNAME: ${{ secrets.PYTHONANYWHERE_USERNAME }}
      run: |
        echo "‚ö†Ô∏è Deployment failed - initiating rollback..."
        # Restore previous stable version
        git checkout HEAD~1
        # Re-deploy previous version
        echo "Rollback would occur here with previous version"

    - name: Create incident notification
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.repo,
            title: 'üö® Deployment Rollback: Production Deploy Failed',
            body: 'The production deployment failed and was rolled back.\n\n**Details:**\n- SHA: ${{ github.sha }}\n- Actor: ${{ github.actor }}\n\nPlease investigate the failure in the workflow logs.',
            labels: ['urgent', 'production']
          })
